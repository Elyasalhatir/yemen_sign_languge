<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù„ØºØ© Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø§Ù„ÙŠÙ…Ù†ÙŠØ© - Ø§Ù„Ù…ØªØ±Ø¬Ù… | Yemeni Sign Language Translator</title>
    <link rel="stylesheet" href="translator-style.css">
    <link rel="stylesheet" href="theme.css">

    <!-- HTTPS Redirect for Mobile Camera Access -->
    <script>
        if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
            location.replace('https:' + window.location.href.substring(window.location.protocol.length));
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js" crossorigin="anonymous"></script>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
</head>

<body>

    <div id="translator-container">
        <!-- Header -->
        <header>
            <h1 data-ar="Ù…ØªØ±Ø¬Ù… Ù„ØºØ© Ø§Ù„Ø¥Ø´Ø§Ø±Ø©" data-en="Sign Language Translator">ğŸ¤Ÿ Sign Language Translator Ù…ØªØ±Ø¬Ù… Ù„ØºØ©
                Ø§Ù„Ø¥Ø´Ø§Ø±Ø©</h1>
            <p class="subtitle" data-ar="ØªØ±Ø¬Ù…Ø© Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ Ù„ØºØ© Ø§Ù„Ø¥Ø´Ø§Ø±Ø©" data-en="Translate text to sign language">Translate
                text to sign language | ØªØ±Ø¬Ù…Ø© Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ Ù„ØºØ© Ø§Ù„Ø¥Ø´Ø§Ø±Ø©</p>
            <a href="welcome.html" class="back-link" data-ar="â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" data-en="â† Back to Home">â† Back to Home
                | Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        </header>

        <!-- Main Content -->
        <div class="content-wrapper">
            <!-- Left: Avatar Display -->
            <div class="avatar-section">
                <!-- Expanded Compact Controls Bar -->
                <div class="compact-controls"
                    style="display: flex; gap: 15px; margin-bottom: 15px; padding: 15px 20px; background: linear-gradient(135deg, rgba(0,242,234,0.1), rgba(255,0,80,0.05)); border-radius: 16px; align-items: center; flex-wrap: wrap; border: 1px solid rgba(255,255,255,0.1);">
                    <select id="avatar-selector"
                        style="padding: 10px 15px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: var(--text-primary); font-size: 0.9rem; cursor: pointer;">
                        <option value="" disabled selected data-ar="Ø§Ø®ØªØ± Ø§Ù„Ø´Ø®ØµÙŠØ©..." data-en="Select Avatar...">ğŸ§› Ø§Ø®ØªØ±
                            Ø§Ù„Ø´Ø®ØµÙŠØ©...</option>
                    </select>
                    <div
                        style="display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.2); padding: 8px 12px; border-radius: 10px;">
                        <span style="font-size: 0.85rem; color: #00f2ea;" data-ar="Ø§Ù„Ø­Ø¬Ù…" data-en="Scale">ğŸ“
                            Ø§Ù„Ø­Ø¬Ù…</span>
                        <input type="range" id="global-scale" min="0.5" max="3" step="0.1" value="1.7"
                            style="width: 80px; accent-color: #00f2ea;" title="Scale">
                    </div>
                    <div
                        style="display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.2); padding: 8px 12px; border-radius: 10px;">
                        <span style="font-size: 0.85rem; color: #00f2ea;" data-ar="Ø§Ù„Ø§Ø±ØªÙØ§Ø¹" data-en="Height">â†•
                            Ø§Ù„Ø§Ø±ØªÙØ§Ø¹</span>
                        <input type="range" id="global-pos-y" min="-3" max="1" step="0.1" value="-1"
                            style="width: 80px; accent-color: #00f2ea;" title="Height">
                    </div>
                    <div
                        style="display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.2); padding: 8px 12px; border-radius: 10px;">
                        <span style="font-size: 0.85rem; color: #ff0050;" data-ar="Ø§Ù„Ø¹Ù…Ù‚" data-en="Depth">â†” Ø§Ù„Ø¹Ù…Ù‚</span>
                        <input type="range" id="global-pos-z" min="-5" max="2" step="0.1" value="-1"
                            style="width: 80px; accent-color: #ff0050;" title="Depth">
                    </div>
                    <div
                        style="display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.2); padding: 8px 12px; border-radius: 10px;">
                        <span style="font-size: 0.85rem; color: #00f2ea;" data-ar="Ø§Ù„Ø¯ÙˆØ±Ø§Ù†" data-en="Rotation">ğŸ”„
                            Ø§Ù„Ø¯ÙˆØ±Ø§Ù†</span>
                        <input type="range" id="global-rot-y" min="-180" max="180" step="1" value="0"
                            style="width: 80px; accent-color: #00f2ea;" title="Rotation">
                    </div>
                </div>
                <div class="avatar-frame">
                    <a-scene embedded vr-mode-ui="enabled: false" style="border-radius: 20px;">
                        <a-asset>
                            <video id="input_video" width="1280" height="720" autoplay muted
                                style="display:none;"></video>
                        </a-asset>

                        <!-- Lighting -->
                        <a-entity light="type: ambient; color: #BBB; intensity: 0.5"></a-entity>
                        <a-entity light="type: directional; color: #FFF; intensity: 0.8; castShadow: true"
                            position="-0.5 1 1"></a-entity>
                        <a-entity light="type: point; color: #00f2ea; intensity: 0.5; distance: 10"
                            position="2 2 2"></a-entity>
                        <a-entity light="type: point; color: #ff0050; intensity: 0.5; distance: 10"
                            position="-2 2 2"></a-entity>

                        <a-sky id="translator-sky" color="#1a1a2e"></a-sky>

                        <script>
                            window.addEventListener('themeChanged', (e) => {
                                const sky = document.getElementById('translator-sky');
                                if (sky) sky.setAttribute('color', e.detail.theme === 'light' ? '#f0f2f5' : '#1a1a2e');
                            });
                            document.addEventListener('DOMContentLoaded', () => {
                                const theme = localStorage.getItem('theme') || 'dark';
                                const sky = document.getElementById('translator-sky');
                                if (sky && theme === 'light') sky.setAttribute('color', '#f0f2f5');
                            });
                        </script>

                        <!-- Avatar -->
                        <a-gltf-model position="0 -1 -1" src="avatars/male.glb" id="male"
                            scale="1.7 1.7 1.7"></a-gltf-model>

                        <!-- Camera -->
                        <a-entity id="camera" camera look-controls="enabled: false" wasd-controls="enabled: false"
                            position="0 1.4 1.2">
                        </a-entity>
                    </a-scene>
                </div>
                <div class="status-indicator">
                    <span class="status-dot"></span>
                    <span id="playback-status" data-ar="Ø¬Ø§Ù‡Ø²" data-en="Ready">Ready | Ø¬Ø§Ù‡Ø²</span>
                </div>
            </div>

            <!-- Right: Control Panel -->
            <div class="control-section">
                <div class="control-card">
                    <h2 data-ar="Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªØ±Ø¬Ù…Ø©" data-en="Translation Input">ğŸ”¤ Translation Input | Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªØ±Ø¬Ù…Ø©</h2>

                    <!-- NOTE: Removed local language selector (replaced by global UI) -->

                    <!-- Input Methods -->
                    <div class="input-group">
                        <input type="text" id="translator-input" data-ar="Ø§ÙƒØªØ¨ Ø¬Ù…Ù„ØªÙƒ Ù‡Ù†Ø§..."
                            data-en="Type your sentence here..."
                            placeholder="Ø§ÙƒØªØ¨ Ø¬Ù…Ù„ØªÙƒ Ù‡Ù†Ø§... | Type your sentence here...">
                        <button id="mic-btn" class="mic-button" title="Voice Input | Ø¥Ø¯Ø®Ø§Ù„ ØµÙˆØªÙŠ">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                                <line x1="12" y1="19" x2="12" y2="23"></line>
                                <line x1="8" y1="23" x2="16" y2="23"></line>
                            </svg>
                        </button>
                    </div>

                    <!-- Translate Button -->
                    <button id="play-btn" class="translate-btn">
                        <span class="btn-icon">â–¶</span>
                        <span data-ar="ØªØ±Ø¬Ù… ÙˆØ´ØºÙ„" data-en="Translate & Play">Translate & Play | ØªØ±Ø¬Ù… ÙˆØ´ØºÙ„</span>
                    </button>

                    <p id="translator-status" class="status-message" data-ar="ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„..."
                        data-en="Waiting for input...">Waiting for input... | ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„...</p>
                </div>

                <!-- Dictionary Display -->
                <div class="control-card dictionary-card">
                    <h2 data-ar="Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©" data-en="Available Words">ğŸ“š Available Words | Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</h2>
                    <div class="dictionary-search">
                        <input type="text" id="dict-search" data-ar="Ø¨Ø­Ø«..." data-en="Search..."
                            placeholder="ğŸ” Search... | Ø¨Ø­Ø«...">
                    </div>
                    <div id="dictionary-list" class="dictionary-list">
                        <p class="loading-text" data-ar="ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù…ÙˆØ³..." data-en="Loading dictionary...">Loading
                            dictionary... | ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù…ÙˆØ³...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Global UI Manager (Theme, Lang, Camera) -->
    <script src="src/global-ui.js"></script>

    <script type="module">
        import MediapipeAvatarManager from './src/MediapipeAvatarManager.js'
        import { TranslatorManager } from './src/TranslatorManager.js';

        const avatarManager = new MediapipeAvatarManager();
        const translatorManager = new TranslatorManager(avatarManager.avatarController);

        // Avatar Loading
        const avatarEl = document.getElementById('male');
        avatarEl.addEventListener('model-loaded', function (evt) {
            const avatar = this.object3D.children[0];
            avatarManager.bindAvatar(avatar, 'RPM');
            console.log("Avatar Loaded in Translator Mode");
        });

        // Initialize settings for ultra-smooth animations
        avatarManager.setUseHand(true);
        avatarManager.setUseKalmanFilter(true); // Enable for smoother tracking
        avatarManager.setSlerpRatio(0.15); // Very low for ultra-smooth transitions (was 0.3)

        console.log("Translator mode initialized with ultra-smooth settings");

        // Load categories and dictionary for categorized display
        let globalDictionary = {};
        let categories = {};

        async function loadAndDisplayDictionary() {
            try {
                const [dictRes, catRes] = await Promise.all([
                    fetch('/dictionary.json'),
                    fetch('/categories.json')
                ]);
                if (dictRes.ok) globalDictionary = await dictRes.json();
                if (catRes.ok) categories = await catRes.json();
                displayCategorizedDictionary();
            } catch (e) {
                console.error("Failed to load dictionary:", e);
                document.getElementById('dictionary-list').innerHTML = '<p class="error-text">Failed to load | ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„</p>';
            }
        }

        function displayCategorizedDictionary() {
            const listEl = document.getElementById('dictionary-list');
            const searchEl = document.getElementById('dict-search');

            if (Object.keys(globalDictionary).length === 0) {
                listEl.innerHTML = '<p class="empty-text">No words yet | Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø§Øª Ø¨Ø¹Ø¯</p>';
                return;
            }

            function renderCategories(filter = '') {
                // If filter is active, only show searching text if using global UI needs logic update in render
                // For now, render direct HTML. 
                // Since this content is dynamic, the global-ui.js won't catch it automatically unless we re-run applyLanguage().
                // However, the categories themselves (name_ar/name_en) are bilingual data.

                // We'll trust the user accepts dynamic content might need a refresh or we can attach data-ar/en classes.
                // Improving render to use data attributes for static parts:

                let html = '';

                // Render each category
                for (const [catKey, cat] of Object.entries(categories)) {
                    const words = cat.words.filter(w =>
                        globalDictionary[w] && (w.includes(filter) || (globalDictionary[w] || '').toLowerCase().includes(filter.toLowerCase()))
                    );
                    if (words.length === 0) continue;

                    html += `
                        <div class="category-block" style="margin-bottom: 15px;">
                            <div class="category-header" onclick="this.nextElementSibling.classList.toggle('hidden')" 
                                 style="cursor: pointer; padding: 10px; background: rgba(0,242,234,0.1); border-radius: 10px; display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 1.3rem;">${cat.icon}</span>
                                <span style="font-weight: 600; color: var(--text-primary);" data-ar="${cat.name_ar}" data-en="${cat.name_en}">${cat.name_ar}</span>
                                <span style="color: var(--text-secondary); font-size: 0.85rem;">(${words.length})</span>
                            </div>
                            <div class="category-words" style="padding: 10px 0;">
                                ${words.map(word => `
                                    <div class="dict-item" onclick="playWord('${word}')" style="cursor: pointer; padding: 8px 12px; margin: 4px 0; background: var(--card-bg); border-radius: 8px; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s;">
                                        <span class="dict-ar" style="font-weight: 500; color: var(--text-primary);">${word}</span>
                                        <span class="dict-en" style="color: var(--text-secondary); font-size: 0.85rem;">${globalDictionary[word]}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                // ... Uncategorized section similar logic ...

                listEl.innerHTML = html || '<p class="empty-text">No results | Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>';

                // Re-apply language to newly created elements
                if (window.globalUI && window.globalUI.applyLanguage) {
                    window.globalUI.applyLanguage(window.globalUI.currentLang);
                }
            }

            renderCategories();
            searchEl.addEventListener('input', (e) => renderCategories(e.target.value));
        }

        // Click-to-play function
        window.playWord = async function (word) {
            const statusEl = document.getElementById('playback-status');
            statusEl.innerText = `â–¶ ${word}...`;

            const animFile = globalDictionary[word]?.toLowerCase();
            if (!animFile) {
                statusEl.innerText = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ© | No animation';
                return;
            }

            try {
                const res = await fetch(`/animations/${animFile}.json`);
                if (!res.ok) throw new Error('Not found');
                const frames = await res.json();
                await translatorManager.animateFrames(frames);
                await translatorManager.returnToRestPose();
                statusEl.innerText = 'Ready | Ø¬Ø§Ù‡Ø²';
            } catch (e) {
                console.warn('Animation not found:', animFile);
                statusEl.innerText = 'Ø§Ù„Ø­Ø±ÙƒØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© | Animation not found';
            }
        };

        loadAndDisplayDictionary();

        // Avatar Selector
        async function loadAvatars() {
            try {
                const res = await fetch('/list-avatars');
                const avatars = await res.json();
                const sel = document.getElementById('avatar-selector');
                avatars.forEach(a => {
                    const opt = document.createElement('option');
                    opt.value = opt.text = a;
                    if (a === 'male.glb') opt.selected = true;
                    sel.appendChild(opt);
                });
            } catch (e) { console.error('Failed to load avatars', e); }
        }
        loadAvatars();

        document.getElementById('avatar-selector').addEventListener('change', (e) => {
            document.getElementById('male').setAttribute('src', 'avatars/' + e.target.value);
        });

        // Global Transforms
        const avatarEntity = document.getElementById('male');
        const controls = [
            { id: 'global-scale', type: 'scale' },
            { id: 'global-pos-y', type: 'pos', axis: 'y' },
            { id: 'global-pos-z', type: 'pos', axis: 'z' },
            { id: 'global-rot-y', type: 'rot', axis: 'y' }
        ];

        function saveGlobal(type, axis, value) {
            const settings = JSON.parse(localStorage.getItem('avatarSettings') || '{}');
            const floatVal = parseFloat(value);
            if (!settings[type]) settings[type] = {};
            if (type === 'scale') settings[type] = floatVal;
            else settings[type][axis] = floatVal;
            localStorage.setItem('avatarSettings', JSON.stringify(settings));
        }

        function applyGlobalSettings() {
            const settings = JSON.parse(localStorage.getItem('avatarSettings') || '{}');
            if (!avatarEntity || !settings) return;

            if (settings.scale) avatarEntity.setAttribute('scale', `${settings.scale} ${settings.scale} ${settings.scale}`);
            if (settings.pos) {
                const p = avatarEntity.getAttribute('position');
                if (settings.pos.x !== undefined) p.x = settings.pos.x;
                if (settings.pos.y !== undefined) p.y = settings.pos.y;
                if (settings.pos.z !== undefined) p.z = settings.pos.z;
                avatarEntity.setAttribute('position', p);
            }
            if (settings.rot) {
                const r = avatarEntity.getAttribute('rotation');
                if (settings.rot.y !== undefined) r.y = settings.rot.y;
                avatarEntity.setAttribute('rotation', r);
            }

            // Sync UI
            controls.forEach(ctrl => {
                const el = document.getElementById(ctrl.id);
                if (ctrl.type === 'scale' && settings.scale) el.value = settings.scale;
                else if (ctrl.type === 'pos' && settings.pos && settings.pos[ctrl.axis] !== undefined) el.value = settings.pos[ctrl.axis];
                else if (ctrl.type === 'rot' && settings.rot && settings.rot[ctrl.axis] !== undefined) el.value = settings.rot[ctrl.axis];
            });
        }

        controls.forEach(ctrl => {
            document.getElementById(ctrl.id).addEventListener('input', (e) => {
                const val = parseFloat(e.target.value);
                if (ctrl.type === 'scale') {
                    avatarEntity.setAttribute('scale', `${val} ${val} ${val}`);
                } else if (ctrl.type === 'pos') {
                    const pos = avatarEntity.getAttribute('position');
                    pos[ctrl.axis] = val;
                    avatarEntity.setAttribute('position', pos);
                } else if (ctrl.type === 'rot') {
                    const rot = avatarEntity.getAttribute('rotation');
                    rot[ctrl.axis] = val;
                    avatarEntity.setAttribute('rotation', rot);
                }
                saveGlobal(ctrl.type, ctrl.axis, val);
            });
        });

        // Load on start
        avatarEntity.addEventListener('model-loaded', () => {
            applyGlobalSettings();
        });

    </script>
</body>

</html>